<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WebView Security Tests (iOS & Android)</title>
<script>

  function addTestResult(testName, result, message) {
    const resultsContainer = document.getElementById('testResults');
    const resultEntry = document.createElement('div');
    resultEntry.textContent = `${testName}: ${result} - ${message}`;
    resultEntry.style.color = result === 'Passed' ? 'green' : 'red';
    resultsContainer.appendChild(resultEntry);
  }
  
  // Camera API Test
 async function testCamera() {
  // Helper function to log test results
  function addTestResult(testName, result, message) {
    const resultsContainer = document.getElementById('testResults');
    const resultEntry = document.createElement('div');
    resultEntry.textContent = `${testName}: ${result} - ${message}`;
    resultEntry.style.color = result === 'Passed' ? 'green' : 'red';
    resultsContainer.appendChild(resultEntry);
  }

  let testName = 'Camera Test';
  // Check if running in secure context
  if (!window.isSecureContext) {
    addTestResult(testName, 'Inconclusive', 'Must be run in a secure context');
    return;
  }
  // Check for mediaDevices support
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    addTestResult(testName, 'Inconclusive', 'Browser does not support getUserMedia');
    return;
  }

  try {
    // Attempt to access the camera
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });

    // Check if a stream was obtained
    if (stream) {
      const video = document.createElement('video');
      video.srcObject = stream;
      video.onloadedmetadata = () => {
        video.play();
        // A timeout to check if the video is playing
        setTimeout(() => {
          if (!video.videoWidth) {
            addTestResult(testName, 'Failed', 'Stream obtained but no video coming through');
          } else {
            addTestResult(testName, 'Failed', 'Camera accessed without permission');
          }
          // Stop the video stream
          stream.getTracks().forEach(track => track.stop());
        }, 1000);
      };
    }
  } catch (error) {
    let message = '';
    if (error.name === 'NotAllowedError') {
      message = 'Permission denied by the user.';
    } else if (error.name === 'NotFoundError') {
      message = 'No camera available on the device.';
    } else if (error.name === 'NotReadableError') {
      message = 'Camera hardware error.';
    } else {
      message = 'Error: ' + error.toString();
    }
    addTestResult(testName, 'Passed', message);
  }
}

  
// File System Access Test for iOS
function testFileSystemIOS() {
  var xhr = new XMLHttpRequest();
  xhr.onload = function() {
    addTestResult('iOS File System Test', 'Failed - Accessed file system', 'fail');
  };
  xhr.onerror = function() {
    addTestResult('iOS File System Test', 'Passed - Unable to access file system', 'pass');
  };
  // Attempting to access a sensitive file which should be inaccessible
  xhr.open('GET', 'file:///var/mobile/Library/Preferences/com.apple.iphonesimulator.plist');
  xhr.send();
}

// JavaScript Bridge Test
function testJSBridge() {
  try {
    window.webkit.messageHandlers.unauthorizedFunction.postMessage("data");
    addTestResult('JS Bridge Test', 'Failed - Message posted to unauthorized handler', 'fail');
  } catch (e) {
    addTestResult('JS Bridge Test', 'Passed - ' + e.toString(), 'pass');
  }
}

// Automatic Phone Call Test
function testPhoneCall() {
  try {
    window.location.href = "tel:+1234567891"; // Attempts to initiate a phone call
    // If no exception is thrown, then it's a fail as the call was initiated without user interaction
    addTestResult('Phone Call Test', 'Failed - Phone call initiated without user interaction', 'fail');
  } catch (e) {
    addTestResult('Phone Call Test', 'Passed - ' + e.toString(), 'pass');
  }
}

// Spoof Address Bar Test
function spoofAddressBar() {
  var newWindow = window.open('https://www.google.com', '_blank', 'width=800,height=600');
  if (newWindow) {
    setTimeout(function() {
      try {
        newWindow.document.body.innerHTML = '<div style="font-family: Arial, sans-serif; text-align: center;"><h1>Google</h1><p>Welcome to Google! (But not really, this is a demonstration of content spoofing.)</p></div>';
        addTestResult('Spoof Address Bar Test', 'Failed - Content spoofed in new window', 'fail');
      } catch (e) {
        addTestResult('Spoof Address Bar Test', 'Passed - ' + e.toString(), 'pass');
      }
    }, 1000);
  } else {
    addTestResult('Spoof Address Bar Test', 'Inconclusive - The new window was not successfully opened.', 'inconclusive');
  }
}


  // Secure Context Test
  function testSecureContext() {
    if (window.isSecureContext) {
      alert('Secure Context Test: Passed - This page is loaded in a secure context');
    } else {
      alert('Secure Context Test: Failed - This page is not loaded in a secure context');
    }
  }

  // WebRTC Leak Test
  function testWebRTCLeak() {
    const pc = new RTCPeerConnection({iceServers: []});
    pc.createDataChannel('');
    pc.createOffer().then(offer => pc.setLocalDescription(offer));
  
    pc.onicecandidate = (ice) => {
      if (!ice || !ice.candidate || !ice.candidate.candidate) return;
      const ipRegex = /([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/;
      const match = ice.candidate.candidate.match(ipRegex);
      if (!match) {
        alert('WebRTC Leak Test: Error - No IP address detected in ICE candidate');
        pc.close();
        return;
      }
      const ip = match[1];
      if (isPublicIP(ip)) {
        alert(`WebRTC Leak Test: Failed - Public IP detected: ${ip}`);
      } else {
        alert('WebRTC Leak Test: Passed - No public IP leak detected');
      }
      pc.close();
    };
  }

function isPublicIP(ip) {
  const parts = ip.split('.').map(str => parseInt(str));
  // Check for private IPv4 addresses
  if (parts.length === 4) {
    return !(
      parts[0] === 10 ||
      (parts[0] === 172 && parts[1] >= 16 && parts[1] <= 31) ||
      (parts[0] === 192 && parts[1] === 168) ||
      // Additional checks for other non-public ranges (e.g., multicast, reserved, loopback)
      parts[0] === 127 ||
      parts[0] >= 224
    );
  }
  // Simplified check for private IPv6 addresses
  return !(ip.includes('fc00:') || ip.includes('fe80:'));
}

  // Clipboard API Test
  async function testClipboardAPI() {
    try {
      const text = await navigator.clipboard.readText();
      alert('Clipboard API Test: Failed - Clipboard content: "' + text + '"');
    } catch (error) {
      alert('Clipboard API Test: Passed - ' + error.toString());
    }
  }

    // GLB File UXSS Test
  function testGLBFileUXSS() {
    const iframe = document.createElement('iframe');
    iframe.src = "https://eliascoin.github.io/webview-security-suite/malicious.glb";
    iframe.onload = () => {
      try {
        if (document.querySelector('#uxssSuccess')) {
          alert('GLB File UXSS Test: Failed - Script executed from GLB file');
        } else {
          alert('GLB File UXSS Test: Passed - No script execution detected');
        }
      } catch(e) {
        alert('GLB File UXSS Test: Passed - ' + e.toString());
      }
    };
    document.body.appendChild(iframe);
  }

  function testMixedContent() {
    const img = new Image();
    img.onload = function() {
      alert('Mixed Content Test: Failed - Insecure content loaded');
      document.body.appendChild(img);

    };
    img.onerror = function() {
      alert('Mixed Content Test: Passed - Blocked insecure content');
    };
    img.src = 'https://eliascoin.github.io/webview-security-suite/image.png';
  }

  function testIntentUrlScheme() {
    try {
      window.location.href = "intent://#Intent;package=com.coinbase.android;end;";
      alert('Intent URL Scheme Test: Failed - Intent URL initiated without user interaction');
    } catch (e) {
      alert('Intent URL Scheme Test: Passed - ' + e.toString());
    }
  }

    function testFileAccess() {
    var xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function() {
      if (xhr.readyState == XMLHttpRequest.DONE) {
        if(xhr.responseText) {
          alert('File Access Test: Failed - Accessed file content: ' + xhr.responseText);
        } else {
          alert('File Access Test: Passed - File access restricted');
        }
      }
    };
    xhr.open('GET', 'file:///sdcard/');
    xhr.send();
  }

  function testJSInterfaceExposure() {
    if (window.Android) {
      alert('JS Interface Exposure Test: Failed - JS Interface is exposed');
    } else {
      alert('JS Interface Exposure Test: Passed - No JS Interface exposure detected');
    }
  }

    // Android Content Scheme Access Test
    function testContentUriAccess() {
      const iframe = document.createElement('iframe');
      iframe.src = "content://0@media/external/file/123";
      iframe.onload = () => {
        try {
          alert('Content URI Access Test: Failed - Loaded content from content:// URI');
        } catch (e) {
          alert('Content URI Access Test: Passed - ' + e.toString());
        }
      };
      iframe.onerror = () => {
        alert('Content URI Access Test: Passed - Could not load content from content:// URI');
      };
      document.body.appendChild(iframe);
    }

</script>
</head>
<body>

<h1>WebView Security Test Page</h1>

<h2>Tests for both iOS & Android</h2>
<!-- Common tests -->
<button onclick="testCamera()">Camera API Test</button>
<button onclick="testPhoneCall()">Automatic Phone Call Test</button>
<button onclick="testSecureContext()">Secure Context Test</button>
<button onclick="testWebRTCLeak()">WebRTC Leak Test</button>
<button onclick="testClipboardAPI()">Clipboard API Test</button>
<button onclick="testMixedContent()">Mixed Content Test</button>
<button onclick="spoofAddressBar()">Spoof Address Bar</button>
<button onclick="testGLBFileUXSS()">GLB File UXSS Test</button>


<h2>iOS Specific Tests</h2>
<!-- iOS-specific tests -->
<button onclick="testJSBridge()">JavaScript Bridge Test</button>
<button onclick="testFileSystemIOS()">File System Access Test</button>


<h2>Android Specific Tests</h2>
<!-- Android-specific tests -->
<button onclick="testIntentUrlScheme()">Intent URL Scheme Test</button>
<button onclick="testFileAccess()">File Access Test</button>
<button onclick="testJSInterfaceExposure()">JavaScript Interface Exposure Test</button>
<button onclick="testContentScheme()">Android Content Scheme Test</button>


<!-- Test results section -->
<div id="testResults" style="margin-top: 20px;">
  <h2>Test Results:</h2>
</div>
  

</body>
</html>
